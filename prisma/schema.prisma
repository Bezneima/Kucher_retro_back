generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

enum AuthProvider {
  LOCAL @map("local")
  GOOGLE @map("google")
}

enum TimerStatus {
  RUNNING
  PAUSED
}

model RetroBoard {
  id          Int           @id @default(autoincrement())
  teamId      Int
  team        Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  name        String
  date        DateTime
  description String        @default("")
  invite      TeamInvite?
  timer       BoardTimer?
  columns     RetroColumn[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([teamId])
  @@map("retro_boards")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String
  name               String?
  authProvider       AuthProvider        @default(LOCAL)
  googleSub          String?             @unique
  googleEmail        String?
  teamMemberships    TeamMember[]
  createdInvites     TeamInvite[]
  createdTimers      BoardTimer[]
  refreshTokens      RefreshToken[]
  authExchangeTokens AuthExchangeToken[]
  retroItemComments RetroItemComment[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@map("users")
}

model BoardTimer {
  id              Int         @id @default(autoincrement())
  boardId         Int         @unique
  createdById     String
  status          TimerStatus
  durationSeconds Int
  remainingSeconds Int
  startedAt       DateTime?
  endsAt          DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  board           RetroBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  createdBy       User        @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([status, endsAt])
  @@map("board_timers")
}

model Team {
  id        Int          @id @default(autoincrement())
  name      String
  isAllCardsHidden Boolean @default(false)
  members   TeamMember[]
  boards    RetroBoard[]
  invites   TeamInvite[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("teams")
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  teamId    Int
  userId    String
  role      TeamRole
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model TeamInvite {
  id            Int       @id @default(autoincrement())
  code          String    @unique
  teamId        Int
  boardId       Int       @unique
  createdById   String
  isActive      Boolean   @default(true)
  acceptedCount Int       @default(0)
  acceptedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  board         RetroBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  createdBy     User      @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([isActive])
  @@map("team_invites")
}

model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model OauthState {
  id        String   @id @default(uuid())
  stateHash String   @unique
  returnTo  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("oauth_states")
}

model AuthExchangeToken {
  id           String   @id @default(uuid())
  tokenHash    String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  usedAt       DateTime?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("auth_exchange_tokens")
}

model RetroColumn {
  id          Int         @id @default(autoincrement())
  name        String
  description String      @default("")
  color       Json
  orderIndex  Int
  boardId     Int
  board       RetroBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  groups      RetroGroup[]
  items       RetroItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([boardId, orderIndex])
  @@map("retro_columns")
}

model RetroGroup {
  id          Int         @id @default(autoincrement())
  columnId    Int
  column      RetroColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  name        String
  description String      @default("")
  color       Json
  orderIndex  Int
  items       RetroItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([columnId, orderIndex])
  @@map("retro_groups")
}

model RetroItem {
  id          Int         @id @default(autoincrement())
  description String
  likes       String[]    @default([])
  color       String?
  rowIndex    Int
  columnId    Int
  groupId     Int?
  column      RetroColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  group       RetroGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  comments    RetroItemComment[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([columnId, groupId, rowIndex])
  @@map("retro_items")
}

model RetroItemComment {
  id        Int       @id @default(autoincrement())
  itemId    Int
  item      RetroItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  creatorId String
  creator   User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  text      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([itemId, createdAt])
  @@index([creatorId])
  @@map("retro_item_comments")
}
